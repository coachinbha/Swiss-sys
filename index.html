<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss System Chess Tournament</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border: 2px solid #333;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tournament-info {
            font-size: 14px;
            margin: 5px 0;
        }

        .section {
            margin-bottom: 30px;
            background: white;
            border: 1px solid #ccc;
        }

        .section-header {
            background: #e6e6e6;
            border-bottom: 2px solid #333;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .section-content {
            padding: 15px;
        }

        /* Input controls */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            min-width: 200px;
        }

        .controls button {
            padding: 8px 16px;
            border: 1px solid #333;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .controls button:hover {
            background: #f0f0f0;
        }
        
        .controls input[type="checkbox"] {
            width: auto;
            min-width: auto;
        }

        .btn-primary { background: #4CAF50 !important; color: white; }
        .btn-danger { background: #f44336 !important; color: white; }
        .btn-warning { background: #ff9800 !important; color: white; }

        /* Tables */
        .swiss-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
        }

        .swiss-table th,
        .swiss-table td {
            border: 1px solid #333;
            padding: 6px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .swiss-table th {
            background: #d6d6d6;
            font-weight: bold;
            font-size: 11px;
        }

        .swiss-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .swiss-table tr:nth-child(odd) {
            background: white;
        }

        /* Player registration table */
        .players-table {
            width: 100%;
        }

        .players-table .name-col { width: 25%; text-align: left; }
        .players-table .score-col { width: 8%; }
        .players-table .games-col { width: 8%; }
        .players-table .status-col { width: 12%; }
        .players-table .action-col { width: 15%; }

        /* Pairings table */
        .pairings-table {
            width: 100%;
            page-break-inside: avoid;
        }

        .pairings-table .board-col { width: 8%; }
        .pairings-table .player-col { width: 20%; text-align: left; }
        .pairings-table .rating-col { width: 8%; }
        .pairings-table .score-col { width: 8%; }
        .pairings-table .result-col { width: 12%; }

        /* Standings table */
        .standings-table {
            width: 100%;
        }

        .standings-table .rank-col { width: 6%; }
        .standings-table .name-col { width: 25%; text-align: left; }
        .standings-table .score-col { width: 8%; }
        .standings-table .games-col { width: 8%; }
        .standings-table .perf-col { width: 10%; }

        /* Round header */
        .round-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            padding: 10px;
            background: #333;
            color: white;
        }

        /* Status indicators */
        .status-active { color: #4CAF50; font-weight: bold; }
        .status-withdrawn { color: #f44336; font-weight: bold; }

        /* Result buttons */
        .result-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .result-buttons button {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #333;
            background: white;
            cursor: pointer;
        }

        .result-buttons .btn-win { background: #4CAF50; color: white; }
        .result-buttons .btn-draw { background: #2196F3; color: white; }
        .result-buttons .btn-loss { background: #f44336; color: white; }
        .result-buttons .btn-forfeit { background: #ff9800; color: white; }

        /* Print styles */
        @media print {
            body { background: white; }
            .container { max-width: none; padding: 10px; }
            .controls, #editPairingsBtn { display: none; }
            .section { page-break-inside: avoid; margin-bottom: 20px; }
            .pairings-table { font-size: 11px; }
            .result-buttons { display: none; }
            .action-col { display: none; }
        }

        @media screen and (max-width: 768px) {
            .swiss-table { font-size: 11px; }
            .swiss-table th, .swiss-table td { padding: 4px; }
            .controls { flex-direction: column; }
            .controls input, .controls button { width: 100%; }
        }

        .bye-row {
            background: #fff3cd !important;
            font-weight: bold;
        }

        .completed-game {
            background: #e8f5e9;
        }

        .player-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tournament-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* Styles for pairing edit mode */
        .editable-player {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable-player:hover {
            background-color: #e3f2fd !important;
        }
        .swap-selected {
            background-color: #ffc107 !important;
            font-weight: bold;
        }
        
        #manualPairingInterface ul {
            list-style-type: none;
            padding-left: 0;
        }
        #manualPairingInterface li {
            padding: 4px;
            border-bottom: 1px solid #eee;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Tournament Header -->
        <div class="header">
            <h1>SWISS SYSTEM CHESS TOURNAMENT</h1>
            <div class="tournament-info">
                <div><strong>Tournament:</strong> <input type="text" id="tournamentNameInput" value="Local Club Championship" style="border: none; background: transparent; font-size: 14px; min-width: 250px;"></div>
                <div><strong>Date:</strong> <span id="tournamentDate"></span></div>
                <div><strong>Arbiter:</strong> <input type="text" id="arbiterNameInput" placeholder="Enter arbiter name" style="border: none; background: transparent; font-size: 14px; min-width: 200px;"></div>
                <div><strong>Time Control:</strong> <input type="text" id="timeControlInput" value="G/90+30" style="border: none; background: transparent; font-size: 14px; min-width: 150px;"></div>
            </div>
        </div>

        <!-- Tournament Statistics -->
        <div class="tournament-stats">
            <div class="stat-box">
                <div class="stat-number" id="totalPlayers">0</div>
                <div class="stat-label">Total Players</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="activePlayers">0</div>
                <div class="stat-label">Active Players</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="currentRoundNum">0</div>
                <div class="stat-label">Current Round</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="completedGames">0</div>
                <div class="stat-label">Completed Games</div>
            </div>
        </div>

        <!-- Player Registration Section -->
        <div class="section">
            <div class="section-header">PLAYER REGISTRATION</div>
            <div class="section-content">
                <div class="controls">
                    <input type="text" id="playerName" placeholder="Player Name" maxlength="30">
                    <button class="btn-primary" onclick="addPlayer()">Add Player</button>
                    <button class="btn-warning" onclick="clearAllPlayers()">Clear All</button>
                </div>
                
                <table class="swiss-table players-table">
                    <thead>
                        <tr>
                            <th class="name-col">PLAYER NAME</th>
                            <th class="score-col">SCORE</th>
                            <th class="games-col">W</th>
                            <th class="games-col">D</th>
                            <th class="games-col">L</th>
                            <th class="games-col">BYES</th>
                            <th class="status-col">STATUS</th>
                            <th class="action-col">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="playersTableBody">
                        <tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players registered</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tournament Control -->
        <div class="section">
            <div class="section-header">TOURNAMENT CONTROL</div>
            <div class="section-content">
                <div class="controls">
                    <button class="btn-primary" onclick="generatePairings()">Generate Next Round</button>
                    <div style="display: flex; align-items: center; gap: 8px; margin-left: 20px;">
                        <input type="checkbox" id="manualPairingMode">
                        <label for="manualPairingMode">Manual Pairing Mode</label>
                    </div>
                </div>
                <div class="controls" style="margin-top: 10px;">
                    <button onclick="printPairings()">🖨️ Print Pairings</button>
                    <button onclick="printStandings()">🖨️ Print Standings</button>
                    <button onclick="generateCrosstable()">📊 Crosstable</button>
                </div>
                 <div class="controls" style="margin-top: 10px;">
                    <button class="btn-warning" onclick="showRollbackUI()" id="rollbackBtn">↩️ Rollback Round</button>
                    <div id="rollbackControls" style="display: none; align-items: center; gap: 10px;">
                        <select id="rollbackRoundSelect"></select>
                        <button onclick="executeRollback()">Confirm</button>
                        <button onclick="hideRollbackUI()">Cancel</button>
                    </div>
                </div>
                <div class="controls" style="margin-top: 10px;">
                    <button onclick="exportTournamentData()">💾 Export Data</button>
                    <label for="importFile" style="cursor: pointer; padding: 8px 16px; border: 1px solid #333; background: white; font-size: 14px; font-weight: bold;">📁 Import Data</label>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTournamentData(event)">
                    <button class="btn-danger" onclick="resetTournament()" style="margin-left: 20px;">Reset Tournament</button>
                </div>
            </div>
        </div>

        <!-- Current Round Pairings -->
        <div class="section" id="pairingsSection" style="display: none;">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div id="roundHeader">ROUND 1 PAIRINGS</div>
                <button id="editPairingsBtn" onclick="togglePairingEditMode()" style="padding: 4px 10px; font-size: 12px; display: none;">Edit Pairings</button>
            </div>
            <div class="section-content">
                <div id="manualPairingInterface" style="display: none; padding: 15px;"></div>
                <table class="swiss-table pairings-table" id="pairingsTable">
                    <thead>
                        <tr>
                            <th class="board-col">BOARD</th>
                            <th class="player-col">WHITE PLAYER</th>
                            <th class="score-col">SCORE</th>
                            <th class="player-col">BLACK PLAYER</th>
                            <th class="score-col">SCORE</th>
                            <th class="result-col">RESULT</th>
                        </tr>
                    </thead>
                    <tbody id="pairingsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tournament Standings -->
        <div class="section">
            <div class="section-header">CURRENT STANDINGS</div>
            <div class="section-content">
                <table class="swiss-table standings-table">
                    <thead>
                        <tr>
                            <th class="rank-col">RANK</th>
                            <th class="name-col">PLAYER NAME</th>
                            <th class="score-col">SCORE</th>
                            <th class="games-col">WINS</th>
                            <th class="games-col">DRAWS</th>
                            <th class="games-col">LOSSES</th>
                            <th class="games-col">BYES</th>
                            <th class="perf-col">STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="standingsTableBody">
                        <tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players to display</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let currentRound = 0;
        let pairings = [];
        let tournamentHistory = [];

        // State for new features
        let isEditMode = false;
        let selectedForSwap = null;
        let tempUnpaired = [];
        let tempPairings = [];

        // Initialize tournament date
        document.getElementById('tournamentDate').textContent = new Date().toLocaleDateString();

        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (name && !players.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                const player = {
                    id: Date.now() + Math.random(),
                    name: name,
                    score: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    byes: 0,
                    opponents: [],
                    colors: [], // 0 = white, 1 = black
                    status: 'active',
                    rating: 'unrated'
                };
                
                players.push(player);
                nameInput.value = '';
                updateAllDisplays();
            } else if (name) {
                alert('Player already exists or name is invalid!');
            }
        }

        function withdrawPlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player && confirm(`Withdraw ${player.name} from tournament?`)) {
                player.status = 'withdrawn';
                updateAllDisplays();
            }
        }

        function reinstatePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                player.status = 'active';
                updateAllDisplays();
            }
        }

        function removePlayer(playerId) {
            if (currentRound > 0) {
                alert('Cannot remove players after tournament has started!');
                return;
            }
            
            if (confirm('Remove player permanently?')) {
                players = players.filter(p => p.id !== playerId);
                updateAllDisplays();
            }
        }

        function clearAllPlayers() {
            if (currentRound > 0) {
                alert('Cannot clear players after tournament has started!');
                return;
            }
            
            if (confirm('Remove all players?')) {
                players = [];
                updateAllDisplays();
            }
        }

        function updatePlayersTable() {
            const tbody = document.getElementById('playersTableBody');
            
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players registered</td></tr>';
                return;
            }
            
            tbody.innerHTML = players.map((player, index) => `
                <tr>
                    <td style="text-align: left; padding-left: 10px;">${player.name}</td>
                    <td><strong>${player.score}</strong></td>
                    <td>${player.wins}</td>
                    <td>${player.draws}</td>
                    <td>${player.losses}</td>
                    <td>${player.byes}</td>
                    <td><span class="status-${player.status}">${player.status.toUpperCase()}</span></td>
                    <td class="action-col">
                        ${player.status === 'active' ? 
                            `<button onclick="withdrawPlayer(${player.id})" style="font-size: 11px; padding: 2px 6px;">Withdraw</button>` :
                            `<button onclick="reinstatePlayer(${player.id})" style="font-size: 11px; padding: 2px 6px;">Reinstate</button>`
                        }
                        <button onclick="removePlayer(${player.id})" style="font-size: 11px; padding: 2px 6px; margin-left: 4px;">Remove</button>
                    </td>
                </tr>
            `).join('');
        }

        function generatePairings() {
            const activePlayers = players.filter(p => p.status === 'active');
            
            if (activePlayers.length < 2) {
                alert('Need at least 2 active players!');
                return;
            }

            // Snapshot the state BEFORE this new round begins
            const playersStateBeforeRound = JSON.parse(JSON.stringify(players));
            
            if (document.getElementById('manualPairingMode').checked) {
                startManualPairing();
                return;
            }
            
            currentRound++;
            
            const sortedPlayers = [...activePlayers].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return Math.random() - 0.5; // Randomize for same score
            });
            
            const paired = new Set();
            const roundPairings = [];
            let boardNumber = 1;
            
            for (let i = 0; i < sortedPlayers.length; i++) {
                if (paired.has(sortedPlayers[i].id)) continue;
                
                const player1 = sortedPlayers[i];
                let player2 = null;
                
                for (let j = i + 1; j < sortedPlayers.length; j++) {
                    const candidate = sortedPlayers[j];
                    if (paired.has(candidate.id) || player1.opponents.includes(candidate.id)) continue;
                    
                    player2 = candidate;
                    break;
                }
                
                if (player2) {
                    const p1WhiteBalance = player1.colors.filter(c => c === 0).length - player1.colors.filter(c => c === 1).length;
                    const p2WhiteBalance = player2.colors.filter(c => c === 0).length - player2.colors.filter(c => c === 1).length;
                    
                    let whitePlayer, blackPlayer;
                    if (p1WhiteBalance < p2WhiteBalance) { [whitePlayer, blackPlayer] = [player1, player2]; } 
                    else if (p2WhiteBalance < p1WhiteBalance) { [whitePlayer, blackPlayer] = [player2, player1]; } 
                    else { [whitePlayer, blackPlayer] = Math.random() < 0.5 ? [player1, player2] : [player2, player1]; }
                    
                    roundPairings.push({
                        id: Date.now() + Math.random(),
                        board: boardNumber++,
                        white: whitePlayer,
                        black: blackPlayer,
                        result: null,
                        round: currentRound
                    });
                    
                    paired.add(player1.id);
                    paired.add(player2.id);
                }
            }
            
            const unpairedPlayer = sortedPlayers.find(p => !paired.has(p.id));
            if (unpairedPlayer) {
                unpairedPlayer.score += 1;
                unpairedPlayer.byes++;
                roundPairings.push({
                    id: Date.now() + Math.random(),
                    board: 'BYE',
                    bye: unpairedPlayer,
                    result: 'bye',
                    round: currentRound
                });
            }
            
            pairings = roundPairings;
            // Push the complete round state to history
            tournamentHistory.push({ round: currentRound, pairings: JSON.parse(JSON.stringify(pairings)), playersStateBeforeRound });
            
            document.getElementById('pairingsSection').style.display = 'block';
            document.getElementById('manualPairingInterface').style.display = 'none';
            document.getElementById('pairingsTable').style.display = '';
            document.getElementById('editPairingsBtn').style.display = 'inline-block';
            updateAllDisplays();
        }

        function updatePairingsTable() {
            const tbody = document.getElementById('pairingsTableBody');
            const header = document.getElementById('roundHeader');
            
            if (currentRound === 0 || pairings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; font-style: italic; color: #666;">No pairings generated</td></tr>';
                document.getElementById('pairingsSection').style.display = 'none';
                return;
            }
            
            header.textContent = `ROUND ${currentRound} PAIRINGS`;
            
            tbody.innerHTML = pairings.map(pairing => {
                if (pairing.bye) {
                    return `<tr class="bye-row"><td><strong>BYE</strong></td><td style="text-align: left; padding-left: 10px;">${pairing.bye.name}</td><td>${pairing.bye.score - 1}</td><td>--- BYE ---</td><td>---</td><td><strong>1-0</strong></td></tr>`;
                }
                
                const resultDisplay = pairing.result ? formatResultForTable(pairing.result) : '';
                const rowClass = pairing.result ? 'completed-game' : '';
                
                const whitePlayerCellAttrs = isEditMode && !pairing.result ? `class="editable-player" onclick="handlePlayerSwapSelection(${pairing.id}, 'white')"` : '';
                const blackPlayerCellAttrs = isEditMode && !pairing.result ? `class="editable-player" onclick="handlePlayerSwapSelection(${pairing.id}, 'black')"` : '';

                if (selectedForSwap && selectedForSwap.pairingId === pairing.id) {
                    const selectedClass = ' swap-selected';
                    if (selectedForSwap.color === 'white') {
                        whitePlayerCellAttrs.replace('editable-player', `editable-player${selectedClass}`);
                    } else {
                        blackPlayerCellAttrs.replace('editable-player', `editable-player${selectedClass}`);
                    }
                }

                return `
                    <tr class="${rowClass}">
                        <td><strong>${pairing.board}</strong></td>
                        <td style="text-align: left; padding-left: 10px;" ${whitePlayerCellAttrs}>${pairing.white.name}</td>
                        <td>${pairing.white.score - getGamePoints(pairing, pairing.white.id)}</td>
                        <td style="text-align: left; padding-left: 10px;" ${blackPlayerCellAttrs}>${pairing.black.name}</td>
                        <td>${pairing.black.score - getGamePoints(pairing, pairing.black.id)}</td>
                        <td>
                            ${!pairing.result ? `
                                <div class="result-buttons">
                                    <button class="btn-win" onclick="recordResult(${pairing.id}, 'white-win')">1-0</button>
                                    <button class="btn-draw" onclick="recordResult(${pairing.id}, 'draw')">½-½</button>
                                    <button class="btn-win" onclick="recordResult(${pairing.id}, 'black-win')">0-1</button>
                                </div>
                            ` : `
                                <div>
                                    <strong>${resultDisplay}</strong><br>
                                    <button onclick="correctResult(${pairing.id})" style="font-size: 10px; padding: 2px 6px; margin-top: 2px; background: #ff9800; color: white; border: none; cursor: pointer;">Correct</button>
                                </div>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');

            if (selectedForSwap) {
                const allCells = document.querySelectorAll('.editable-player');
                allCells.forEach(cell => {
                    const onclickAttr = cell.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`handlePlayerSwapSelection(${selectedForSwap.pairingId}, '${selectedForSwap.color}')`)) {
                        cell.classList.add('swap-selected');
                    }
                });
            }
        }

        function getGamePoints(pairing, playerId) {
            if (!pairing.result) return 0;
            const results = { 'white-win': 1, 'black-forfeit': 1, 'black-win': 0, 'white-forfeit': 0, 'draw': 0.5, 'double-forfeit': 0 };
            const isWhite = pairing.white && pairing.white.id === playerId;
            return isWhite ? results[pairing.result] : (1 - results[pairing.result] || 0);
        }

        function recordResult(pairingId, result) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing) return;
            
            if (pairing.result) revertResult(pairing);
            else {
                pairing.white.colors.push(0); pairing.black.colors.push(1);
                pairing.white.opponents.push(pairing.black.id);
                pairing.black.opponents.push(pairing.white.id);
            }
            
            pairing.result = result;
            
            const outcomes = {
                'white-win': { w: pairing.white, l: pairing.black, score: 1 },
                'black-win': { w: pairing.black, l: pairing.white, score: 1 },
                'draw': { d1: pairing.white, d2: pairing.black, score: 0.5 },
                'black-forfeit': { w: pairing.white, l: pairing.black, score: 1 },
                'white-forfeit': { w: pairing.black, l: pairing.white, score: 1 },
                'double-forfeit': { l1: pairing.white, l2: pairing.black, score: 0 }
            };

            const outcome = outcomes[result];
            if (outcome.w) { outcome.w.score += outcome.score; outcome.w.wins++; outcome.l.losses++; }
            if (outcome.d1) { outcome.d1.score += outcome.score; outcome.d2.score += outcome.score; outcome.d1.draws++; outcome.d2.draws++; }
            if (outcome.l1) { outcome.l1.losses++; outcome.l2.losses++; }
            
            updateAllDisplays();
        }
        
        function revertResult(pairing) {
            if (!pairing.result) return;
            
            const outcomes = {
                'white-win': { w: pairing.white, l: pairing.black, score: 1 },
                'black-win': { w: pairing.black, l: pairing.white, score: 1 },
                'draw': { d1: pairing.white, d2: pairing.black, score: 0.5 },
                'black-forfeit': { w: pairing.white, l: pairing.black, score: 1 },
                'white-forfeit': { w: pairing.black, l: pairing.white, score: 1 },
                'double-forfeit': { l1: pairing.white, l2: pairing.black, score: 0 }
            };

            const outcome = outcomes[pairing.result];
            if (outcome.w) { outcome.w.score -= outcome.score; outcome.w.wins--; outcome.l.losses--; }
            if (outcome.d1) { outcome.d1.score -= outcome.score; outcome.d2.score -= outcome.score; outcome.d1.draws--; outcome.d2.draws--; }
            if (outcome.l1) { outcome.l1.losses--; outcome.l2.losses--; }
        }
        
        function correctResult(pairingId) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing || !pairing.result) return;
            const newResult = prompt(`Enter new result (1-0, 0-1, ½-½)`);
            if (!newResult) return;
            
            const resultCodes = { '1-0': 'white-win', '0-1': 'black-win', '½-½': 'draw', '1/2-1/2': 'draw' };
            const resultCode = resultCodes[newResult.trim()];
            
            if (resultCode && resultCode !== pairing.result) recordResult(pairingId, resultCode);
            else if (resultCode) alert('Result is already set to that value.');
            else alert('Invalid result format!');
        }

        function formatResultForTable(result) {
            const results = { 'white-win': '1-0', 'black-win': '0-1', 'draw': '½-½', 'white-forfeit': '0-1 (F)', 'black-forfeit': '1-0 (F)', 'double-forfeit': '0-0 (F)' };
            return results[result] || result;
        }

        function updateStandingsTable() {
            const tbody = document.getElementById('standingsTableBody');
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players to display</td></tr>';
                return;
            }
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score || b.wins - a.wins || a.name.localeCompare(b.name));
            tbody.innerHTML = sortedPlayers.map((p, i) => `<tr><td><strong>${i + 1}</strong></td><td style="text-align: left; padding-left: 10px;">${p.name}</td><td><strong>${p.score}</strong></td><td>${p.wins}</td><td>${p.draws}</td><td>${p.losses}</td><td>${p.byes}</td><td><span class="status-${p.status}">${p.status.toUpperCase()}</span></td></tr>`).join('');
        }

        function updateTournamentStats() {
            document.getElementById('totalPlayers').textContent = players.length;
            document.getElementById('activePlayers').textContent = players.filter(p => p.status === 'active').length;
            document.getElementById('currentRoundNum').textContent = currentRound;
            document.getElementById('completedGames').textContent = pairings.filter(p => p.result && !p.bye).length;
            document.getElementById('rollbackBtn').style.display = currentRound > 0 ? 'inline-block' : 'none';
        }

        function updateAllDisplays() {
            updatePlayersTable();
            updatePairingsTable();
            updateStandingsTable();
            updateTournamentStats();
            hideRollbackUI();
        }

        // --- MANUAL PAIRING ---
        function startManualPairing() {
            const playersStateBeforeRound = JSON.parse(JSON.stringify(players));
            currentRound++;
            const activePlayers = players.filter(p => p.status === 'active');
            tempUnpaired = [...activePlayers].sort((a, b) => b.score - a.score);
            tempPairings = [];
            
            document.getElementById('pairingsSection').style.display = 'block';
            document.getElementById('pairingsTable').style.display = 'none';
            document.getElementById('editPairingsBtn').style.display = 'none';
            document.getElementById('manualPairingInterface').style.display = 'block';
            
            // Temporarily store the state for cancellation
            tempPairings.playersStateBeforeRound = playersStateBeforeRound;
            
            renderManualPairingUI();
        }

        function renderManualPairingUI() {
            const container = document.getElementById('manualPairingInterface');
            const unpairedOptions = tempUnpaired.map(p => `<option value="${p.id}">${p.name} (${p.score})</option>`).join('');
            const pairingsList = tempPairings.map(p => `<li>Board ${p.board}: ${p.bye ? `${p.bye.name} (BYE)` : `${p.white.name} vs ${p.black.name}`}</li>`).join('');

            container.innerHTML = `
                <h3>Manual Pairing for Round ${currentRound}</h3>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <h4>Unpaired Players (${tempUnpaired.length})</h4>
                        <ul>${tempUnpaired.map(p => `<li>${p.name} (${p.score})</li>`).join('')}</ul>
                        ${tempUnpaired.length === 1 ? `<button class="btn-primary" onclick="assignByeFromUI()" style="margin-top: 10px;">Assign Bye</button>` : ''}
                    </div>
                    <div>
                        <h4>Create Pairings</h4>
                        <div class="controls">
                            <select id="manualWhitePlayer" ${tempUnpaired.length < 2 ? 'disabled' : ''}>${unpairedOptions}</select>
                            <select id="manualBlackPlayer" ${tempUnpaired.length < 2 ? 'disabled' : ''}>${unpairedOptions}</select>
                            <button onclick="addManualPairingFromUI()" ${tempUnpaired.length < 2 ? 'disabled' : ''}>Add Pairing</button>
                        </div>
                        <h4>Created Pairings (${tempPairings.length})</h4>
                        <ul>${pairingsList}</ul>
                    </div>
                </div>
                <hr style="margin: 20px 0;">
                <button class="btn-primary" onclick="finalizeManualPairings()">Finalize Pairings</button>
                <button onclick="cancelManualPairing()">Cancel</button>
            `;
        }
        
        function addManualPairingFromUI() {
            const whiteId = parseFloat(document.getElementById('manualWhitePlayer').value);
            const blackId = parseFloat(document.getElementById('manualBlackPlayer').value);

            if (whiteId === blackId) { alert("A player cannot play against themselves."); return; }

            const whitePlayer = tempUnpaired.find(p => p.id === whiteId);
            const blackPlayer = tempUnpaired.find(p => p.id === blackId);
            
            tempPairings.push({
                id: Date.now() + Math.random(),
                board: tempPairings.filter(p => !p.bye).length + 1,
                white: whitePlayer,
                black: blackPlayer,
                result: null,
                round: currentRound
            });
            
            tempUnpaired = tempUnpaired.filter(p => p.id !== whiteId && p.id !== blackId);
            renderManualPairingUI();
        }

        function assignByeFromUI() {
            if (tempUnpaired.length !== 1) return;
            const byePlayer = tempUnpaired[0];
            byePlayer.score += 1;
            byePlayer.byes++;
            
            tempPairings.push({
                id: Date.now() + Math.random(),
                board: 'BYE',
                bye: byePlayer,
                result: 'bye',
                round: currentRound
            });
            tempUnpaired = [];
            renderManualPairingUI();
        }

        function finalizeManualPairings() {
            if (tempUnpaired.length > 0) { alert(`There are still ${tempUnpaired.length} unpaired players.`); return; }
            
            pairings = [...tempPairings];
            const playersStateBeforeRound = tempPairings.playersStateBeforeRound;
            tournamentHistory.push({ round: currentRound, pairings: JSON.parse(JSON.stringify(pairings)), playersStateBeforeRound });
            
            document.getElementById('manualPairingInterface').style.display = 'none';
            document.getElementById('pairingsTable').style.display = '';
            
            tempPairings = []; tempUnpaired = [];
            updateAllDisplays();
        }

        function cancelManualPairing() {
            if (!confirm("Cancel manual pairing and discard changes?")) return;
            currentRound--; // Revert round increment
            tempPairings = []; tempUnpaired = [];
            document.getElementById('manualPairingInterface').style.display = 'none';
            document.getElementById('pairingsSection').style.display = currentRound > 0 ? 'block' : 'none';
            updateAllDisplays();
        }

        // --- EDIT PAIRINGS ---
        function togglePairingEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('editPairingsBtn');
            btn.textContent = isEditMode ? 'Finish Editing' : 'Edit Pairings';
            btn.classList.toggle('btn-danger', isEditMode);
            
            if (!isEditMode) {
                selectedForSwap = null;
            }
            updatePairingsTable();
        }

        function handlePlayerSwapSelection(pairingId, color) {
            if (!isEditMode) return;
            pairingId = parseFloat(pairingId);

            if (!selectedForSwap) {
                selectedForSwap = { pairingId, color };
            } else {
                if (selectedForSwap.pairingId === pairingId && selectedForSwap.color === color) {
                    selectedForSwap = null;
                } else {
                    performSwap(selectedForSwap, { pairingId, color });
                    selectedForSwap = null;
                }
            }
            updatePairingsTable();
        }

        function performSwap(selection1, selection2) {
            const pairing1 = pairings.find(p => p.id === selection1.pairingId);
            const pairing2 = pairings.find(p => p.id === selection2.pairingId);

            if (!pairing1 || !pairing2 || pairing1.result || pairing2.result) {
                alert("Cannot swap players in completed games.");
                return;
            }

            const player1 = pairing1[selection1.color];
            const player2 = pairing2[selection2.color];

            pairing1[selection1.color] = player2;
            pairing2[selection2.color] = player1;
        }

        // --- NEW FEATURE: ROLLBACK ROUND ---
        function showRollbackUI() {
            if (currentRound < 1) return;
            const select = document.getElementById('rollbackRoundSelect');
            select.innerHTML = '';
            for (let i = 1; i < currentRound + 1; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Back to Start of Round ${i}`;
                select.appendChild(option);
            }
            select.value = currentRound;
            document.getElementById('rollbackBtn').style.display = 'none';
            document.getElementById('rollbackControls').style.display = 'flex';
        }

        function hideRollbackUI() {
            document.getElementById('rollbackBtn').style.display = currentRound > 0 ? 'inline-block' : 'none';
            document.getElementById('rollbackControls').style.display = 'none';
        }

        function executeRollback() {
            const targetRound = parseInt(document.getElementById('rollbackRoundSelect').value);
            if (isNaN(targetRound)) return;

            if (!confirm(`This will revert all progress back to the beginning of Round ${targetRound}. Are you sure?`)) {
                hideRollbackUI();
                return;
            }

            const historyEntry = tournamentHistory.find(h => h.round === targetRound);
            if (!historyEntry) {
                alert('Error: Could not find history for that round.');
                return;
            }

            // Restore state from the deep copies in the history object
            players = JSON.parse(JSON.stringify(historyEntry.playersStateBeforeRound));
            pairings = JSON.parse(JSON.stringify(historyEntry.pairings));
            currentRound = targetRound;

            // Trim the history to the point of the rollback
            tournamentHistory = tournamentHistory.slice(0, tournamentHistory.findIndex(h => h.round === targetRound) + 1);

            alert(`Successfully rolled back to Round ${targetRound}.`);
            updateAllDisplays();
        }

        // --- UTILITY & I/O Functions ---
        function printPairings() {
            if (currentRound === 0) { alert('No pairings to print!'); return; }
            const tournamentName = document.getElementById('tournamentNameInput').value;
            const printWindow = window.open('', '_blank');
            const pairingsTableHTML = document.getElementById('pairingsTable').outerHTML.replace(/<div class="result-buttons">.*?<\/div>/gs, '___________').replace(/<button.*?correctResult.*?>.*?<\/button>/gs, '');
            printWindow.document.write(`<html><head><title>Round ${currentRound} Pairings</title><style>body{font-family:Arial} table{width:100%;border-collapse:collapse} th,td{border:1px solid #333;padding:8px;text-align:center} th{background:#d6d6d6}</style></head><body><h1>${tournamentName} - Round ${currentRound} Pairings</h1>${pairingsTableHTML}</body></html>`);
            printWindow.document.close();
            printWindow.print();
        }

        function printStandings() {
            const tournamentName = document.getElementById('tournamentNameInput').value;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>Standings</title><style>body{font-family:Arial} table{width:100%;border-collapse:collapse} th,td{border:1px solid #333;padding:8px;text-align:center} th{background:#d6d6d6}</style></head><body><h1>${tournamentName} - Standings after Round ${currentRound}</h1>${document.querySelector('.standings-table').outerHTML}</body></html>`);
            printWindow.document.close();
            printWindow.print();
        }

        function resetTournament() {
            if (confirm('Reset entire tournament? This will clear all data.')) {
                players = []; currentRound = 0; pairings = []; tournamentHistory = [];
                document.getElementById('pairingsSection').style.display = 'none';
                updateAllDisplays();
            }
        }

        document.getElementById('playerName').addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer(); });
        
        function exportTournamentData() {
            const dataStr = JSON.stringify({ players, currentRound, pairings, tournamentHistory }, null, 2);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
            link.download = `tournament_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        
        function importTournamentData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('Import data? This will overwrite the current tournament.')) {
                        players = data.players || [];
                        currentRound = data.currentRound || 0;
                        pairings = data.pairings || [];
                        tournamentHistory = data.tournamentHistory || [];
                        document.getElementById('pairingsSection').style.display = currentRound > 0 ? 'block' : 'none';
                        updateAllDisplays();
                        alert('Tournament data imported!');
                    }
                } catch (error) { alert('Error importing file: ' + error.message); }
            };
            reader.readAsText(file);
        }
        
        function generateCrosstable() { alert('Crosstable feature not yet implemented.'); }

        // --- NEW FEATURE: PREVENT ACCIDENTAL CLOSE ---
        window.addEventListener('beforeunload', function (e) {
            if (players.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initial Load
        updateAllDisplays();
    </script>
</body>
</html>
