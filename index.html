<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss System Chess Tournament</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border: 2px solid #333;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tournament-info {
            font-size: 14px;
            margin: 5px 0;
        }

        .section {
            margin-bottom: 30px;
            background: white;
            border: 1px solid #ccc;
        }

        .section-header {
            background: #e6e6e6;
            border-bottom: 2px solid #333;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .section-content {
            padding: 15px;
        }

        /* Input controls */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls input {
            padding: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            min-width: 200px;
        }

        .controls button {
            padding: 8px 16px;
            border: 1px solid #333;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .controls button:hover {
            background: #f0f0f0;
        }

        .btn-primary { background: #4CAF50 !important; color: white; }
        .btn-danger { background: #f44336 !important; color: white; }
        .btn-warning { background: #ff9800 !important; color: white; }

        /* Tables */
        .swiss-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
        }

        .swiss-table th,
        .swiss-table td {
            border: 1px solid #333;
            padding: 6px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .swiss-table th {
            background: #d6d6d6;
            font-weight: bold;
            font-size: 11px;
        }

        .swiss-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .swiss-table tr:nth-child(odd) {
            background: white;
        }

        /* Player registration table */
        .players-table {
            width: 100%;
        }

        .players-table th {
            background: #e6e6e6;
        }

        .players-table .name-col { width: 25%; text-align: left; }
        .players-table .score-col { width: 8%; }
        .players-table .games-col { width: 8%; }
        .players-table .status-col { width: 12%; }
        .players-table .action-col { width: 15%; }

        /* Pairings table */
        .pairings-table {
            width: 100%;
            page-break-inside: avoid;
        }

        .pairings-table .board-col { width: 8%; }
        .pairings-table .player-col { width: 20%; text-align: left; }
        .pairings-table .rating-col { width: 8%; }
        .pairings-table .score-col { width: 8%; }
        .pairings-table .result-col { width: 12%; }

        /* Standings table */
        .standings-table {
            width: 100%;
        }

        .standings-table .rank-col { width: 6%; }
        .standings-table .name-col { width: 25%; text-align: left; }
        .standings-table .score-col { width: 8%; }
        .standings-table .games-col { width: 8%; }
        .standings-table .perf-col { width: 10%; }

        /* Round header */
        .round-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            padding: 10px;
            background: #333;
            color: white;
        }

        /* Status indicators */
        .status-active { color: #4CAF50; font-weight: bold; }
        .status-withdrawn { color: #f44336; font-weight: bold; }

        /* Result buttons */
        .result-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .result-buttons button {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #333;
            background: white;
            cursor: pointer;
        }

        .result-buttons .btn-win { background: #4CAF50; color: white; }
        .result-buttons .btn-draw { background: #2196F3; color: white; }
        .result-buttons .btn-loss { background: #f44336; color: white; }
        .result-buttons .btn-forfeit { background: #ff9800; color: white; }

        /* Print styles */
        @media print {
            body { background: white; }
            .container { max-width: none; padding: 10px; }
            .controls { display: none; }
            .section { page-break-inside: avoid; margin-bottom: 20px; }
            .pairings-table { font-size: 11px; }
            .result-buttons { display: none; }
            .action-col { display: none; }
        }

        @media screen and (max-width: 768px) {
            .swiss-table { font-size: 11px; }
            .swiss-table th, .swiss-table td { padding: 4px; }
            .controls { flex-direction: column; }
            .controls input, .controls button { width: 100%; }
        }

        .bye-row {
            background: #fff3cd !important;
            font-weight: bold;
        }

        .completed-game {
            background: #e8f5e8;
        }

        .player-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tournament-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tournament Header -->
        <div class="header">
            <h1>SWISS SYSTEM CHESS TOURNAMENT</h1>
            <div class="tournament-info">
                <div><strong>Tournament:</strong> <input type="text" id="tournamentNameInput" value="Local Club Championship" style="border: none; background: transparent; font-size: 14px; min-width: 250px;"></div>
                <div><strong>Date:</strong> <span id="tournamentDate"></span></div>
                <div><strong>Arbiter:</strong> <input type="text" id="arbiterNameInput" placeholder="Enter arbiter name" style="border: none; background: transparent; font-size: 14px; min-width: 200px;"></div>
                <div><strong>Time Control:</strong> <input type="text" id="timeControlInput" value="G/90+30" style="border: none; background: transparent; font-size: 14px; min-width: 150px;"></div>
            </div>
        </div>

        <!-- Tournament Statistics -->
        <div class="tournament-stats">
            <div class="stat-box">
                <div class="stat-number" id="totalPlayers">0</div>
                <div class="stat-label">Total Players</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="activePlayers">0</div>
                <div class="stat-label">Active Players</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="currentRoundNum">0</div>
                <div class="stat-label">Current Round</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="completedGames">0</div>
                <div class="stat-label">Completed Games</div>
            </div>
        </div>

        <!-- Player Registration Section -->
        <div class="section">
            <div class="section-header">PLAYER REGISTRATION</div>
            <div class="section-content">
                <div class="controls">
                    <input type="text" id="playerName" placeholder="Player Name" maxlength="30">
                    <button class="btn-primary" onclick="addPlayer()">Add Player</button>
                    <button class="btn-warning" onclick="clearAllPlayers()">Clear All</button>
                </div>
                
                <table class="swiss-table players-table">
                    <thead>
                        <tr>
                            <th class="name-col">PLAYER NAME</th>
                            <th class="score-col">SCORE</th>
                            <th class="games-col">W</th>
                            <th class="games-col">D</th>
                            <th class="games-col">L</th>
                            <th class="games-col">BYES</th>
                            <th class="status-col">STATUS</th>
                            <th class="action-col">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="playersTableBody">
                        <tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players registered</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tournament Control -->
        <div class="section">
            <div class="section-header">TOURNAMENT CONTROL</div>
            <div class="section-content">
                <div class="controls">
                    <button class="btn-primary" onclick="generatePairings()">Generate Next Round</button>
                    <button onclick="printPairings()" style="margin-left: 20px;">🖨️ Print Pairings</button>
                    <button onclick="printStandings()">🖨️ Print Standings</button>
                    <button onclick="generateCrosstable()">📊 Crosstable</button>
                </div>
                <div class="controls" style="margin-top: 10px;">
                    <button onclick="exportTournamentData()">💾 Export Data</button>
                    <label for="importFile" style="cursor: pointer; padding: 8px 16px; border: 1px solid #333; background: white; font-size: 14px; font-weight: bold;">📁 Import Data</label>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTournamentData(event)">
                    <button class="btn-danger" onclick="resetTournament()" style="margin-left: 20px;">Reset Tournament</button>
                </div>
            </div>
        </div>

        <!-- Current Round Pairings -->
        <div class="section" id="pairingsSection" style="display: none;">
            <div class="round-header" id="roundHeader">ROUND 1 PAIRINGS</div>
            <div class="section-content">
                <table class="swiss-table pairings-table" id="pairingsTable">
                    <thead>
                        <tr>
                            <th class="board-col">BOARD</th>
                            <th class="player-col">WHITE PLAYER</th>
                            <th class="score-col">SCORE</th>
                            <th class="player-col">BLACK PLAYER</th>
                            <th class="score-col">SCORE</th>
                            <th class="result-col">RESULT</th>
                        </tr>
                    </thead>
                    <tbody id="pairingsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tournament Standings -->
        <div class="section">
            <div class="section-header">CURRENT STANDINGS</div>
            <div class="section-content">
                <table class="swiss-table standings-table">
                    <thead>
                        <tr>
                            <th class="rank-col">RANK</th>
                            <th class="name-col">PLAYER NAME</th>
                            <th class="score-col">SCORE</th>
                            <th class="games-col">WINS</th>
                            <th class="games-col">DRAWS</th>
                            <th class="games-col">LOSSES</th>
                            <th class="games-col">BYES</th>
                            <th class="perf-col">STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="standingsTableBody">
                        <tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players to display</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let currentRound = 0;
        let pairings = [];
        let tournamentHistory = [];

        // Initialize tournament date
        document.getElementById('tournamentDate').textContent = new Date().toLocaleDateString();

        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (name && !players.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                const player = {
                    id: Date.now() + Math.random(),
                    name: name,
                    score: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    byes: 0,
                    opponents: [],
                    colors: [], // 0 = white, 1 = black
                    status: 'active',
                    rating: 'unrated'
                };
                
                players.push(player);
                nameInput.value = '';
                updateAllDisplays();
            } else if (name) {
                alert('Player already exists or name is invalid!');
            }
        }

        function withdrawPlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player && confirm(`Withdraw ${player.name} from tournament?`)) {
                player.status = 'withdrawn';
                updateAllDisplays();
            }
        }

        function reinstatePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                player.status = 'active';
                updateAllDisplays();
            }
        }

        function removePlayer(playerId) {
            if (currentRound > 0) {
                alert('Cannot remove players after tournament has started!');
                return;
            }
            
            if (confirm('Remove player permanently?')) {
                players = players.filter(p => p.id !== playerId);
                updateAllDisplays();
            }
        }

        function clearAllPlayers() {
            if (currentRound > 0) {
                alert('Cannot clear players after tournament has started!');
                return;
            }
            
            if (confirm('Remove all players?')) {
                players = [];
                updateAllDisplays();
            }
        }

        function updatePlayersTable() {
            const tbody = document.getElementById('playersTableBody');
            
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players registered</td></tr>';
                return;
            }
            
            tbody.innerHTML = players.map((player, index) => `
                <tr>
                    <td style="text-align: left; padding-left: 10px;">${player.name}</td>
                    <td><strong>${player.score}</strong></td>
                    <td>${player.wins}</td>
                    <td>${player.draws}</td>
                    <td>${player.losses}</td>
                    <td>${player.byes}</td>
                    <td><span class="status-${player.status}">${player.status.toUpperCase()}</span></td>
                    <td class="action-col">
                        ${player.status === 'active' ? 
                            `<button onclick="withdrawPlayer(${player.id})" style="font-size: 11px; padding: 2px 6px;">Withdraw</button>` :
                            `<button onclick="reinstatePlayer(${player.id})" style="font-size: 11px; padding: 2px 6px;">Reinstate</button>`
                        }
                        <button onclick="removePlayer(${player.id})" style="font-size: 11px; padding: 2px 6px; margin-left: 4px;">Remove</button>
                    </td>
                </tr>
            `).join('');
        }

        function generatePairings() {
            const activePlayers = players.filter(p => p.status === 'active');
            
            if (activePlayers.length < 2) {
                alert('Need at least 2 active players!');
                return;
            }
            
            currentRound++;
            
            // Sort players by score (descending), then by wins
            const sortedPlayers = [...activePlayers].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return 0;
            });
            
            const paired = new Set();
            const roundPairings = [];
            let boardNumber = 1;
            
            // Swiss pairing algorithm
            for (let i = 0; i < sortedPlayers.length; i++) {
                if (paired.has(sortedPlayers[i].id)) continue;
                
                const player1 = sortedPlayers[i];
                let player2 = null;
                
                // Find best opponent, avoiding repeats
                for (let j = i + 1; j < sortedPlayers.length; j++) {
                    const candidate = sortedPlayers[j];
                    if (paired.has(candidate.id)) continue;
                    if (player1.opponents.includes(candidate.id)) continue;
                    
                    player2 = candidate;
                    break;
                }
                
                if (player2) {
                    // Color assignment logic
                    const p1WhiteBalance = player1.colors.filter(c => c === 0).length - player1.colors.filter(c => c === 1).length;
                    const p2WhiteBalance = player2.colors.filter(c => c === 0).length - player2.colors.filter(c => c === 1).length;
                    
                    let whitePlayer, blackPlayer;
                    
                    if (p1WhiteBalance < p2WhiteBalance) {
                        whitePlayer = player1;
                        blackPlayer = player2;
                    } else if (p2WhiteBalance < p1WhiteBalance) {
                        whitePlayer = player2;
                        blackPlayer = player1;
                    } else {
                        // Random if balanced
                        if (Math.random() < 0.5) {
                            whitePlayer = player1;
                            blackPlayer = player2;
                        } else {
                            whitePlayer = player2;
                            blackPlayer = player1;
                        }
                    }
                    
                    roundPairings.push({
                        id: Date.now() + Math.random(),
                        board: boardNumber++,
                        white: whitePlayer,
                        black: blackPlayer,
                        result: null,
                        round: currentRound
                    });
                    
                    paired.add(player1.id);
                    paired.add(player2.id);
                }
            }
            
            // Handle bye
            const unpairedPlayers = sortedPlayers.filter(p => !paired.has(p.id));
            if (unpairedPlayers.length === 1) {
                const byePlayer = unpairedPlayers[0];
                byePlayer.score += 1;
                byePlayer.byes++;
                
                roundPairings.push({
                    id: Date.now() + Math.random(),
                    board: 'BYE',
                    bye: byePlayer,
                    result: 'bye',
                    round: currentRound
                });
            }
            
            pairings = roundPairings;
            tournamentHistory.push([...roundPairings]);
            
            updateAllDisplays();
            document.getElementById('pairingsSection').style.display = 'block';
        }

        function updatePairingsTable() {
            const tbody = document.getElementById('pairingsTableBody');
            const header = document.getElementById('roundHeader');
            
            if (currentRound === 0 || pairings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No pairings generated</td></tr>';
                return;
            }
            
            header.textContent = `ROUND ${currentRound} PAIRINGS`;
            
            tbody.innerHTML = pairings.map(pairing => {
                if (pairing.bye) {
                    return `
                        <tr class="bye-row">
                            <td><strong>BYE</strong></td>
                            <td style="text-align: left; padding-left: 10px;">${pairing.bye.name}</td>
                            <td>${pairing.bye.score - 1}</td>
                            <td>--- BYE ---</td>
                            <td>---</td>
                            <td><strong>1-0</strong></td>
                        </tr>
                    `;
                }
                
                const resultDisplay = pairing.result ? formatResultForTable(pairing.result) : '';
                const rowClass = pairing.result ? 'completed-game' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td><strong>${pairing.board}</strong></td>
                        <td style="text-align: left; padding-left: 10px;">${pairing.white.name}</td>
                        <td>${pairing.white.score - getGamePoints(pairing, pairing.white.id)}</td>
                        <td style="text-align: left; padding-left: 10px;">${pairing.black.name}</td>
                        <td>${pairing.black.score - getGamePoints(pairing, pairing.black.id)}</td>
                        <td>
                            ${!pairing.result ? `
                                <div class="result-buttons">
                                    <button class="btn-win" onclick="recordResult(${pairing.id}, 'white-win')">1-0</button>
                                    <button class="btn-draw" onclick="recordResult(${pairing.id}, 'draw')">½-½</button>
                                    <button class="btn-win" onclick="recordResult(${pairing.id}, 'black-win')">0-1</button>
                                    <button class="btn-forfeit" onclick="recordResult(${pairing.id}, 'white-forfeit')">W-F</button>
                                    <button class="btn-forfeit" onclick="recordResult(${pairing.id}, 'black-forfeit')">B-F</button>
                                    <button class="btn-forfeit" onclick="recordResult(${pairing.id}, 'double-forfeit')">D-F</button>
                                </div>
                            ` : `
                                <div>
                                    <strong>${resultDisplay}</strong>
                                    <br>
                                    <button onclick="correctResult(${pairing.id})" style="font-size: 10px; padding: 2px 6px; margin-top: 2px; background: #ff9800; color: white; border: none; cursor: pointer;">Correct</button>
                                </div>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getGamePoints(pairing, playerId) {
            if (!pairing.result) return 0;
            
            switch(pairing.result) {
                case 'white-win':
                case 'black-forfeit':
                    return pairing.white.id === playerId ? 1 : 0;
                case 'black-win':
                case 'white-forfeit':
                    return pairing.black.id === playerId ? 1 : 0;
                case 'draw':
                    return 0.5;
                case 'double-forfeit':
                    return 0;
                default:
                    return 0;
            }
        }

        function recordResult(pairingId, result) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing) return;
            
            // If result already exists, we're correcting it - revert first
            if (pairing.result) {
                revertResult(pairing);
            } else {
                // First time recording - add colors and opponents
                pairing.white.colors.push(0);
                pairing.black.colors.push(1);
                pairing.white.opponents.push(pairing.black.id);
                pairing.black.opponents.push(pairing.white.id);
            }
            
            pairing.result = result;
            
            // Apply new result
            switch(result) {
                case 'white-win':
                    pairing.white.score += 1;
                    pairing.white.wins++;
                    pairing.black.losses++;
                    break;
                case 'black-win':
                    pairing.black.score += 1;
                    pairing.black.wins++;
                    pairing.white.losses++;
                    break;
                case 'draw':
                    pairing.white.score += 0.5;
                    pairing.black.score += 0.5;
                    pairing.white.draws++;
                    pairing.black.draws++;
                    break;
                case 'white-forfeit':
                    pairing.black.score += 1;
                    pairing.black.wins++;
                    pairing.white.losses++;
                    break;
                case 'black-forfeit':
                    pairing.white.score += 1;
                    pairing.white.wins++;
                    pairing.black.losses++;
                    break;
                case 'double-forfeit':
                    pairing.white.losses++;
                    pairing.black.losses++;
                    break;
            }
            
            updateAllDisplays();
        }
        
        function revertResult(pairing) {
            if (!pairing.result) return;
            
            // Revert the previous result
            switch(pairing.result) {
                case 'white-win':
                    pairing.white.score -= 1;
                    pairing.white.wins--;
                    pairing.black.losses--;
                    break;
                case 'black-win':
                    pairing.black.score -= 1;
                    pairing.black.wins--;
                    pairing.white.losses--;
                    break;
                case 'draw':
                    pairing.white.score -= 0.5;
                    pairing.black.score -= 0.5;
                    pairing.white.draws--;
                    pairing.black.draws--;
                    break;
                case 'white-forfeit':
                    pairing.black.score -= 1;
                    pairing.black.wins--;
                    pairing.white.losses--;
                    break;
                case 'black-forfeit':
                    pairing.white.score -= 1;
                    pairing.white.wins--;
                    pairing.black.losses--;
                    break;
                case 'double-forfeit':
                    pairing.white.losses--;
                    pairing.black.losses--;
                    break;
            }
        }
        
        function correctResult(pairingId) {
            const pairing = pairings.find(p => p.id === pairingId);
            if (!pairing || !pairing.result) return;
            
            const currentResult = formatResultForTable(pairing.result);
            const newResult = prompt(`Current result: ${currentResult}\n\nEnter new result:\n1-0 (White wins)\n0-1 (Black wins)\n½-½ (Draw)\nW-F (White forfeit)\nB-F (Black forfeit)\nD-F (Double forfeit)`, currentResult);
            
            if (!newResult) return;
            
            let resultCode = '';
            switch(newResult.toUpperCase()) {
                case '1-0':
                    resultCode = 'white-win';
                    break;
                case '0-1':
                    resultCode = 'black-win';
                    break;
                case '½-½':
                case '1/2-1/2':
                case 'DRAW':
                    resultCode = 'draw';
                    break;
                case 'W-F':
                case 'WHITE FORFEIT':
                    resultCode = 'white-forfeit';
                    break;
                case 'B-F':
                case 'BLACK FORFEIT':
                    resultCode = 'black-forfeit';
                    break;
                case 'D-F':
                case 'DOUBLE FORFEIT':
                    resultCode = 'double-forfeit';
                    break;
                default:
                    alert('Invalid result format!');
                    return;
            }
            
            if (resultCode !== pairing.result) {
                recordResult(pairingId, resultCode);
            }
        }

        function formatResultForTable(result) {
            const results = {
                'white-win': '1-0',
                'black-win': '0-1',
                'draw': '½-½',
                'white-forfeit': '0-1 (W-F)',
                'black-forfeit': '1-0 (B-F)',
                'double-forfeit': '0-0 (D-F)'
            };
            return results[result] || result;
        }

        function updateStandingsTable() {
            const tbody = document.getElementById('standingsTableBody');
            
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; font-style: italic; color: #666;">No players to display</td></tr>';
                return;
            }
            
            // Sort by score, wins, then alphabetically
            const sortedPlayers = [...players].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return a.name.localeCompare(b.name);
            });
            
            tbody.innerHTML = sortedPlayers.map((player, index) => `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td style="text-align: left; padding-left: 10px;">${player.name}</td>
                    <td><strong>${player.score}</strong></td>
                    <td>${player.wins}</td>
                    <td>${player.draws}</td>
                    <td>${player.losses}</td>
                    <td>${player.byes}</td>
                    <td><span class="status-${player.status}">${player.status.toUpperCase()}</span></td>
                </tr>
            `).join('');
        }

        function updateTournamentStats() {
            const totalPlayers = players.length;
            const activePlayers = players.filter(p => p.status === 'active').length;
            const completedGames = pairings.filter(p => p.result && !p.bye).length;
            
            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('activePlayers').textContent = activePlayers;
            document.getElementById('currentRoundNum').textContent = currentRound;
            document.getElementById('completedGames').textContent = completedGames;
        }

        function updateAllDisplays() {
            updatePlayersTable();
            updatePairingsTable();
            updateStandingsTable();
            updateTournamentStats();
        }

        function printPairings() {
            // Get current tournament info
            const tournamentName = document.getElementById('tournamentNameInput').value || 'Chess Tournament';
            const arbiterName = document.getElementById('arbiterNameInput').value || '_________________';
            const timeControl = document.getElementById('timeControlInput').value || 'G/90+30';
            const tournamentDate = document.getElementById('tournamentDate').textContent;
            
            if (currentRound === 0) {
                alert('No pairings to print!');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const pairingsTable = document.getElementById('pairingsTable').cloneNode(true);
            
            // Remove action buttons from print version
            const resultCells = pairingsTable.querySelectorAll('.result-buttons');
            resultCells.forEach(cell => {
                const parent = cell.parentNode;
                parent.innerHTML = '___________';
            });
            
            // Remove correct buttons
            const correctButtons = pairingsTable.querySelectorAll('button[onclick*="correctResult"]');
            correctButtons.forEach(btn => btn.remove());
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Round ${currentRound} Pairings</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border: 2px solid #333; padding: 20px; }
                        .header h1 { font-size: 24px; margin-bottom: 5px; }
                        .tournament-info { font-size: 14px; margin: 5px 0; }
                        .round-header { text-align: center; font-size: 18px; font-weight: bold; margin: 20px 0; padding: 10px; background: #333; color: white; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                        th { background: #d6d6d6; font-weight: bold; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .bye-row { background: #fff3cd !important; font-weight: bold; }
                        .player-col { text-align: left; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>SWISS SYSTEM CHESS TOURNAMENT</h1>
                        <div class="tournament-info">
                            <div><strong>Tournament:</strong> ${tournamentName}</div>
                            <div><strong>Date:</strong> ${tournamentDate}</div>
                            <div><strong>Arbiter:</strong> ${arbiterName}</div>
                            <div><strong>Time Control:</strong> ${timeControl}</div>
                        </div>
                    </div>
                    <div class="round-header">ROUND ${currentRound} PAIRINGS</div>
                    ${pairingsTable.outerHTML}
                    <br><br>
                    <div style="display: flex; justify-content: space-between;">
                        <div>Arbiter Signature: _________________</div>
                        <div>Date: _________________</div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function printStandings() {
            // Get current tournament info
            const tournamentName = document.getElementById('tournamentNameInput').value || 'Chess Tournament';
            const arbiterName = document.getElementById('arbiterNameInput').value || '_________________';
            const timeControl = document.getElementById('timeControlInput').value || 'G/90+30';
            const tournamentDate = document.getElementById('tournamentDate').textContent;
            
            const standingsTable = document.querySelector('.standings-table').cloneNode(true);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Tournament Standings</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border: 2px solid #333; padding: 20px; }
                        .header h1 { font-size: 24px; margin-bottom: 5px; }
                        .tournament-info { font-size: 14px; margin: 5px 0; }
                        .standings-header { text-align: center; font-size: 18px; font-weight: bold; margin: 20px 0; padding: 10px; background: #333; color: white; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                        th { background: #d6d6d6; font-weight: bold; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .name-col { text-align: left; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>SWISS SYSTEM CHESS TOURNAMENT</h1>
                        <div class="tournament-info">
                            <div><strong>Tournament:</strong> ${tournamentName}</div>
                            <div><strong>Date:</strong> ${tournamentDate}</div>
                            <div><strong>Arbiter:</strong> ${arbiterName}</div>
                            <div><strong>Time Control:</strong> ${timeControl}</div>
                        </div>
                    </div>
                    <div class="standings-header">TOURNAMENT STANDINGS AFTER ROUND ${currentRound}</div>
                    ${standingsTable.outerHTML}
                    <br><br>
                    <div style="display: flex; justify-content: space-between;">
                        <div>Arbiter Signature: _________________</div>
                        <div>Date: _________________</div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function resetTournament() {
            if (confirm('Reset entire tournament? This will clear all data.')) {
                players = [];
                currentRound = 0;
                pairings = [];
                tournamentHistory = [];
                document.getElementById('pairingsSection').style.display = 'none';
                updateAllDisplays();
            }
        }

        // Enter key support
        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addPlayer();
            }
        });

        // Initialize
        updateAllDisplays();
        
        // Additional utility functions for tournament management
        
        function exportTournamentData() {
            const data = {
                players: players,
                currentRound: currentRound,
                pairings: pairings,
                tournamentHistory: tournamentHistory,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `tournament_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        function importTournamentData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('Import tournament data? This will overwrite current tournament.')) {
                        players = data.players || [];
                        currentRound = data.currentRound || 0;
                        pairings = data.pairings || [];
                        tournamentHistory = data.tournamentHistory || [];
                        
                        if (currentRound > 0) {
                            document.getElementById('pairingsSection').style.display = 'block';
                        }
                        
                        updateAllDisplays();
                        alert('Tournament data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Add crosstable generation
        function generateCrosstable() {
            if (players.length === 0) {
                alert('No players to generate crosstable!');
                return;
            }
            
            const crosstableWindow = window.open('', '_blank');
            const sortedPlayers = [...players].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return a.name.localeCompare(b.name);
            });
            
            let crosstableHTML = `
                <html>
                <head>
                    <title>Tournament Crosstable</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                        th { background: #e6e6e6; font-weight: bold; }
                        .player-name { text-align: left; font-weight: bold; }
                        .result-1 { background: #90EE90; } /* Win */
                        .result-0 { background: #FFB6C1; } /* Loss */
                        .result-05 { background: #FFFFE0; } /* Draw */
                        .result-bye { background: #DDA0DD; } /* Bye */
                    </style>
                </head>
                <body>
                    <h1>Tournament Crosstable</h1>
                    <table>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
            `;
            
            // Add round headers
            for (let round = 1; round <= currentRound; round++) {
                crosstableHTML += `<th>R${round}</th>`;
            }
            crosstableHTML += `<th>Total</th></tr>`;
            
            // Add player rows
            sortedPlayers.forEach((player, index) => {
                crosstableHTML += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td class="player-name">${player.name}</td>
                        <td><strong>${player.score}</strong></td>
                `;
                
                // Add results for each round
                for (let round = 1; round <= currentRound; round++) {
                    const roundHistory = tournamentHistory[round - 1];
                    if (roundHistory) {
                        const playerGame = roundHistory.find(pairing => 
                            (pairing.white && pairing.white.id === player.id) ||
                            (pairing.black && pairing.black.id === player.id) ||
                            (pairing.bye && pairing.bye.id === player.id)
                        );
                        
                        if (playerGame) {
                            if (playerGame.bye) {
                                crosstableHTML += `<td class="result-bye">BYE</td>`;
                            } else {
                                const isWhite = playerGame.white.id === player.id;
                                const opponent = isWhite ? playerGame.black : playerGame.white;
                                const opponentRank = sortedPlayers.findIndex(p => p.id === opponent.id) + 1;
                                
                                let result = '';
                                let resultClass = '';
                                
                                if (!playerGame.result) {
                                    result = `${opponentRank}*`;
                                } else {
                                    switch (playerGame.result) {
                                        case 'white-win':
                                            result = isWhite ? `${opponentRank}+` : `${opponentRank}-`;
                                            resultClass = isWhite ? 'result-1' : 'result-0';
                                            break;
                                        case 'black-win':
                                            result = isWhite ? `${opponentRank}-` : `${opponentRank}+`;
                                            resultClass = isWhite ? 'result-0' : 'result-1';
                                            break;
                                        case 'draw':
                                            result = `${opponentRank}=`;
                                            resultClass = 'result-05';
                                            break;
                                        case 'white-forfeit':
                                            result = isWhite ? `${opponentRank}F-` : `${opponentRank}F+`;
                                            resultClass = isWhite ? 'result-0' : 'result-1';
                                            break;
                                        case 'black-forfeit':
                                            result = isWhite ? `${opponentRank}F+` : `${opponentRank}F-`;
                                            resultClass = isWhite ? 'result-1' : 'result-0';
                                            break;
                                        case 'double-forfeit':
                                            result = `${opponentRank}FF`;
                                            resultClass = 'result-0';
                                            break;
                                    }
                                }
                                
                                crosstableHTML += `<td class="${resultClass}">${result}</td>`;
                            }
                        } else {
                            crosstableHTML += `<td>-</td>`;
                        }
                    } else {
                        crosstableHTML += `<td>-</td>`;
                    }
                }
                
                crosstableHTML += `<td><strong>${player.score}</strong></td></tr>`;
            });
            
            crosstableHTML += `
                    </table>
                    <br>
                    <p><strong>Legend:</strong> + = Win, - = Loss, = = Draw, BYE = Bye, F = Forfeit, * = Game in progress</p>
                    <p>Numbers indicate opponent's final ranking</p>
                </body>
                </html>
            `;
            
            crosstableWindow.document.write(crosstableHTML);
            crosstableWindow.document.close();
        }
    </script>
</body>
</html>
